<?php
// $Id$


function crumbs_perm() {
  return array('administer crumbs');
}


function crumbs_menu() {
  $items = array();
  $items['admin/build/crumbs'] = array(
    'title' => 'Crumbs',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('crumbs_admin_form'),
    'access arguments' => array('administer crumbs'),
    'file' => 'crumbs.admin.inc',
  );
  return $items;
}


function crumbs_theme() {
  return array(
    'crumbs_breadcrumb' => array('breadcrumb_items' => NULL),
  );
}


function crumbs_preprocess_page(&$vars) {
  $breadcrumb_data = crumbs_get_breadcrumb_data();
  $vars['crumbs_trail'] = $breadcrumb_data['trail'];
  $vars['crumbs_breadcrumb_items'] = $breadcrumb_data['items'];
  $vars['crumbs_breadcrumb_html'] = $breadcrumb_data['html'];
  $vars['breadcrumb'] = $breadcrumb_data['html'];
  // TODO: Invoke preprocessPage() plugin method.
  $pluginEngine = crumbs_get_plugin_engine();
  $invokeAction = new _crumbs_InvokeAction_preprocessPage($vars);
  $pluginEngine->invokeAllReverse($invokeAction);
}


function crumbs_get_breadcrumb_data() {
  static $_data;
  if (!isset($_data)) {
    $trail = crumbs_get_trail();
    module_load_include('inc', 'crumbs', 'crumbs.breadcrumb');
    $items = crumbs_build_breadcrumb($trail);
    $html = theme('crumbs_breadcrumb', $items);
    $_data = compact('trail', 'items', 'html');
  }
  return $_data;
}


function crumbs_get_trail() {
  static $_trail;
  if (!isset($_trail)) {
    module_load_include('inc', 'crumbs', 'crumbs.plugin_engine');
    module_load_include('inc', 'crumbs', 'crumbs.trail');
    $_trail = crumbs_build_trail($_GET['q']);
  }
  return $_trail;
}


function crumbs_get_plugin_engine() {
  static $_plugin_engine;
  if (!isset($_plugin_engine)) {
    module_load_include('inc', 'crumbs', 'crumbs.plugin_engine');
    $_plugin_engine = _crumbs_load_plugin_engine();
  }
  return $_plugin_engine;
}


class _crumbs_InvokeAction_preprocessPage {

  protected $_vars;

  function __construct(array &$vars) {
    $this->_vars = &$vars;
  }

  /**
   * The point of the preprocessPage() method hook is a guaranteed execution
   * directly after crumbs_preprocess_page().
   */
  function invoke($plugin, $plugin_key) {
    if (method_exists($plugin, 'preprocessPage')) {
      $plugin->preprocessPage($this->_vars);
    }
  }
}




